<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Snapgram HD</title>
<link rel="icon" href="data:,">
<style>
  html,body{height:100%;margin:0;background:#000;font-family:Arial}
  #preview { position:fixed; inset:0; width:100vw; height:100vh; display:block; background:#000; z-index:1; }
  video#sourceVideo { position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; }
  #captureBtn{
    position:fixed; bottom:26px; left:50%; transform:translateX(-50%);
    width:84px; height:84px; border-radius:50%;
    background:#fff; border:6px solid rgba(255,255,255,0.7); z-index:50;
  }
  #flipBtn{
    position:fixed; top:20px; right:20px;
    padding:8px 14px; color:#fff; background:rgba(0,0,0,0.5);
    border-radius:20px; border:1px solid rgba(255,255,255,0.3); z-index:50;
  }
</style>
</head>
<body>

<video id="sourceVideo" autoplay playsinline muted></video>
<canvas id="preview"></canvas>
<img id="frameImg" src="frame.png" style="display:none">

<button id="captureBtn"></button>
<button id="flipBtn">Flip</button>

<script>
const OUT_W = 1080, OUT_H = 1920;

const sourceVideo = document.getElementById("sourceVideo");
const preview = document.getElementById("preview");
const frameImg = document.getElementById("frameImg");

const pctx = preview.getContext("2d");

function fitPreview() {
  preview.width = window.innerWidth;
  preview.height = window.innerHeight;
}
fitPreview();
window.addEventListener("resize", fitPreview);

let usingFront = false;
let stream = null;
let micStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let holding = false;
let pressTimer = null;

// CANVAS KHUSUS OUTPUT 1080x1920
const procCanvas = document.createElement("canvas");
procCanvas.width = OUT_W;
procCanvas.height = OUT_H;
const procCtx = procCanvas.getContext("2d");

// Start kamera
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: usingFront ? "user" : "environment",
      width: { ideal: 4000 },
      height: { ideal: 4000 }
    },
    audio: false
  });

  sourceVideo.srcObject = stream;
  await sourceVideo.play();
  requestAnimationFrame(previewLoop);
}

function previewLoop() {
  drawToCanvas();
  requestAnimationFrame(previewLoop);
}

function drawToCanvas() {
  let vW = sourceVideo.videoWidth;
  let vH = sourceVideo.videoHeight;

  if (!vW || !vH) return;

  let ratioVideo = vW / vH;
  let ratioTarget = OUT_W / OUT_H;

  let sx = 0, sy = 0, sw = vW, sh = vH;

  if (ratioVideo > ratioTarget) {
    sw = vH * ratioTarget;
    sx = (vW - sw) / 2;
  } else {
    sh = vW / ratioTarget;
    sy = (vH - sh) / 2;
  }

  procCtx.drawImage(sourceVideo, sx, sy, sw, sh, 0, 0, OUT_W, OUT_H);
  procCtx.drawImage(frameImg, 0, 0, OUT_W, OUT_H);

  // tampil ke layar
  pctx.drawImage(procCanvas, 0, 0, preview.width, preview.height);
}

// FOTO
function takePhoto() {
  drawToCanvas();
  let url = procCanvas.toDataURL("image/jpeg", 0.92);
  download(url, "photo_hd_1080x1920.jpg");
}

// VIDEO TANPA FFMPEG â†’ OUTPUT .MP4
async function startRecording() {
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

  const canvasStream = procCanvas.captureStream(30);
  const finalStream = new MediaStream([
    ...canvasStream.getVideoTracks(),
    ...micStream.getAudioTracks()
  ]);

  mediaRecorder = new MediaRecorder(finalStream, {
    mimeType: "video/webm;codecs=vp8,opus"
  });

  recordedChunks = [];
  mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);

  mediaRecorder.start();
}

function stopRecording() {
  mediaRecorder.stop();

  setTimeout(() => {
    const blob = new Blob(recordedChunks, { type: "video/webm" });

    // rename menjadi MP4
    const renamedBlob = new Blob([blob], { type: "video/mp4" });
    const url = URL.createObjectURL(renamedBlob);

    download(url, "video_hd_1080x1920.mp4");

    micStream.getTracks().forEach(t => t.stop());
  }, 300);
}

function download(url, name) {
  const a = document.createElement("a");
  a.href = url;
  a.download = name;
  a.click();
}

// Button Logic
const captureBtn = document.getElementById("captureBtn");

captureBtn.addEventListener("mousedown", () => {
  pressTimer = setTimeout(() => {
    holding = true;
    startRecording();
  }, 350);
});

captureBtn.addEventListener("mouseup", () => {
  clearTimeout(pressTimer);
  if (holding) stopRecording();
  else takePhoto();
  holding = false;
});

// Flip Kamera
document.getElementById("flipBtn").onclick = () => {
  usingFront = !usingFront;
  startCamera();
};

startCamera();
</script>

</body>
</html>
