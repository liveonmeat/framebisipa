<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frame Camera - Full HD Portrait</title>

<style>
    body, html {
        margin:0;
        padding:0;
        overflow:hidden;
        background:#000;
        font-family: Arial, sans-serif;
    }

    /* Canvas tempat video + frame digabung */
    #previewCanvas {
        position: fixed;
        top:0;
        left:0;
        width:100vw;
        height:100vh;
        z-index: 1;
        background:#000;
    }

    /* Switch camera button */
    #switchBtn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.5);
        color:white;
        padding: 9px 16px;
        border-radius: 10px;
        border: 1px solid white;
        font-size: 16px;
    }

    /* Timer */
    #timer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        color:white;
        font-size: 22px;
        display:none;
    }

    /* Control buttons */
    #controls {
        position: fixed;
        bottom: 25px;
        width: 100%;
        text-align: center;
        z-index: 10000;
    }

    button {
        background: white;
        padding: 14px 28px;
        border-radius: 14px;
        border: none;
        font-size: 18px;
        margin: 5px;
    }
</style>
</head>

<body>

<canvas id="previewCanvas"></canvas>

<button id="switchBtn">Switch</button>
<div id="timer">00:00</div>

<div id="controls">
    <button id="photoBtn">Foto</button>
    <button id="recordBtn">Rekam</button>
</div>

<script>
let canvas = document.getElementById("previewCanvas");
let ctx = canvas.getContext("2d");

let facing = "environment";
let videoStream;
let video = document.createElement("video");
video.playsinline = true;
video.muted = true;
video.autoplay = true;

let frameImg = new Image();
frameImg.src = "frame.png";

let recording = false;
let chunks = [];
let recorder;

let timerLabel = document.getElementById("timer");
let timerInterval = null;
let sec = 0;

/* =====================================
   START CAMERA (BACK CAMERA DEFAULT)
===================================== */
async function startCamera() {
    if (videoStream) videoStream.getTracks().forEach(t => t.stop());

    try {
        videoStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1080 },
                height: { ideal: 1920 },
                facingMode: facing
            },
            audio: true
        });
    } catch (err) {
        videoStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
    }

    video.srcObject = videoStream;

    video.onloadedmetadata = () => {
        resizeCanvas();
        drawLoop();
    };
}

function resizeCanvas() {
    canvas.width = 1080;
    canvas.height = 1920;
}

/* =====================================
   DRAW FRAME + VIDEO (PORTRAIT)
===================================== */
function drawLoop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // gambar kamera
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // gambar frame PNG
    ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);

    requestAnimationFrame(drawLoop);
}

/* =====================================
   TAKE PHOTO (PORTRAIT + FRAME)
===================================== */
document.getElementById("photoBtn").onclick = () => {
    let url = canvas.toDataURL("image/png");
    download(url, "foto.png");
};

/* =====================================
   RECORD VIDEO (CANVAS STREAM)
===================================== */
document.getElementById("recordBtn").onclick = () => {
    if (!recording) startRecord();
    else stopRecord();
};

function startRecord() {
    recording = true;
    document.getElementById("recordBtn").innerText = "Stop";

    chunks = [];
    let canvasStream = canvas.captureStream(30);

    recorder = new MediaRecorder(canvasStream, {
        mimeType: "video/webm; codecs=vp9",
        videoBitsPerSecond: 8000000
    });

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        let blob = new Blob(chunks, { type: "video/webm" });
        let url = URL.createObjectURL(blob);
        download(url, "video.webm");
    };

    recorder.start();

    // start timer
    sec = 0;
    timerLabel.style.display = "block";
    timerInterval = setInterval(() => {
        sec++;
        timerLabel.textContent =
            `00:${sec.toString().padStart(2,"0")}`;
    }, 1000);
}

function stopRecord() {
    recording = false;
    document.getElementById("recordBtn").innerText = "Rekam";

    recorder.stop();

    // stop timer
    clearInterval(timerInterval);
    timerLabel.style.display = "none";
}

/* =====================================
   SWITCH CAMERA
===================================== */
document.getElementById("switchBtn").onclick = () => {
    facing = (facing === "environment") ? "user" : "environment";
    startCamera();
};

/* =====================================
   DOWNLOAD
===================================== */
function download(url, name) {
    let a = document.createElement("a");
    a.href = url;
    a.download = name;
    a.click();
}

/* START */
startCamera();
</script>

</body>
</html>
