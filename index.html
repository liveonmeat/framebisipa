<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snapgram Camera</title>

<style>
    body,html{
        margin:0;
        padding:0;
        overflow:hidden;
        background:#000;
        height:100%;
    }

    #camera {
        position:fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        object-fit:cover;
        z-index:1;
    }

    #frame {
        position:fixed;
        top:0;
        left:0;
        width:100vw;
        height:100vh;
        object-fit:cover;        /* FIX FRAME 9:16 */
        z-index:3;
        pointer-events:none;
    }

    #captureBtn {
        position:fixed;
        bottom:30px;
        left:50%;
        transform:translateX(-50%);
        width:80px;
        height:80px;
        border-radius:50%;
        border:4px solid #fff;
        background:rgba(255,255,255,0.2);
        z-index:5;
        touch-action:none;
    }
</style>
</head>

<body>

<video id="camera" autoplay playsinline></video>
<img id="frame" src="frame.png">

<button id="captureBtn"></button>

<script>
    const video = document.getElementById("camera");
    const btn = document.getElementById("captureBtn");

    let recorder;
    let chunks = [];
    let recording = false;
    let pressTimer;

    // -------------------------
    // START CAMERA (HIGH QUALITY)
    // -------------------------
    navigator.mediaDevices.getUserMedia({
        video: {
            facingMode: "environment",
            width: { ideal: 1080 },
            height: { ideal: 1920 }
        },
        audio: true
    }).then(stream => {
        video.srcObject = stream;
    });

    // -------------------------
    // PHOTO CAPTURE (CLICK)
    // -------------------------
    function takePhoto() {
        let canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        let ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Gambar frame di atas
        let frameImg = document.getElementById("frame");
        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);

        let url = canvas.toDataURL("image/jpeg");
        downloadFile(url, "photo.jpg");
    }

    // -------------------------
    // VIDEO RECORD (HOLD PRESS)
    // -------------------------
    function startRecording() {
        const stream = video.srcObject;
        recorder = new MediaRecorder(stream, {
            mimeType: "video/webm; codecs=vp9"
        });

        recorder.ondataavailable = e => chunks.push(e.data);

        recorder.onstop = () => {
            let blob = new Blob(chunks, { type: "video/webm" });
            chunks = [];

            // Convert ke MP4 pakai ffmpeg.js (versi ringan)
            convertToMp4(blob);
        };

        recorder.start();
        recording = true;
    }

    function stopRecording() {
        if (recording) {
            recorder.stop();
            recording = false;
        }
    }

    // -------------------------
    // BUTTON EVENT
    // -------------------------
    btn.addEventListener("mousedown", () => {
        pressTimer = setTimeout(() => {
            startRecording(); // tahan → rekam
        }, 300);
    });

    btn.addEventListener("mouseup", () => {
        if (!recording) {
            clearTimeout(pressTimer);
            takePhoto(); // klik cepat → foto
        } else {
            stopRecording();
        }
    });

    // -------------------------
    // DOWNLOAD UTILS
    // -------------------------
    function downloadFile(url, filename) {
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
    }

    // MP4 CONVERTER (Mini FFmpeg)
    async function convertToMp4(webmBlob) {
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        await ffmpeg.load();
        ffmpeg.FS("writeFile", "input.webm", await fetchFile(webmBlob));
        await ffmpeg.run("-i", "input.webm", "output.mp4");

        const mp4Data = ffmpeg.FS("readFile", "output.mp4");
        const mp4Blob = new Blob([mp4Data.buffer], { type: "video/mp4" });

        downloadFile(URL.createObjectURL(mp4Blob), "video.mp4");
    }
</script>

<!-- FFMPEG.JS -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>

</body>
</html>
