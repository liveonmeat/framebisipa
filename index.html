<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SnapCam 1080x1920</title>

<style>
    body, html {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        background: #000;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }

    #preview {
        position: fixed;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
        z-index: 1;
    }

    #frame {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        pointer-events: none;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 2;
    }

    #captureBtn {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        width: 85px; height: 85px;
        border-radius: 50%;
        background: white;
        border: 4px solid #ddd;
        box-shadow: 0 0 5px #000;
        z-index: 3;
    }

    #captureBtn:active {
        transform: translateX(-50%) scale(0.9);
    }
</style>
</head>

<body>

<video id="preview" autoplay playsinline></video>
<div id="frame"></div>

<button id="captureBtn"></button>

<script>
const preview = document.getElementById("preview");
const frame = document.getElementById("frame");
const captureBtn = document.getElementById("captureBtn");

let mediaStream;
let mediaRecorder;
let chunks = [];
let isRecording = false;
let pressTimer;

// SET FRAME (PASTIKAN frame.png ADA DI FOLDER YANG SAMA)
frame.style.backgroundImage = "url('frame.png')";

// =============================
// START CAMERA
// =============================
async function startCamera() {
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "user",
                width: { ideal: 1080 },
                height: { ideal: 1920 }
            },
            audio: true
        });

        preview.srcObject = mediaStream;
    } catch (err) {
        console.error("Tidak bisa akses kamera/mic:", err);
        alert("Gagal akses kamera/mikrofon. Cek izin browser.");
    }
}

startCamera();

// =============================
// TAKE PHOTO
// =============================
function takePhoto() {
    if (!preview.videoWidth || !preview.videoHeight) {
        alert("Video belum siap. Coba lagi sebentar.");
        return;
    }

    const canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 1920;

    const ctx = canvas.getContext("2d");

    // Gambar video
    ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);

    // (Opsional) gambar frame ke foto juga:
    // Jika ingin overlay ikut tersimpan di foto, load image frame.png di sini.

    canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        downloadFile(url, "photo.jpg");
    }, "image/jpeg", 0.95);
}

// =============================
// PILIH MIME TYPE YANG DIDUKUNG
// =============================
function getSupportedMimeType() {
    const types = [
        "video/mp4",
        "video/webm;codecs=vp9",
        "video/webm;codecs=vp8",
        "video/webm"
    ];

    for (const type of types) {
        if (MediaRecorder.isTypeSupported(type)) {
            return type;
        }
    }
    return ""; // biar MediaRecorder pakai default
}

// =============================
// START RECORDING
// =============================
function startRecord() {
    if (!mediaStream) {
        alert("Kamera belum aktif.");
        return;
    }

    chunks = [];

    const mimeType = getSupportedMimeType();
    const options = {};
    if (mimeType) {
        options.mimeType = mimeType;
    }

    try {
        mediaRecorder = new MediaRecorder(mediaStream, options);
    } catch (e) {
        console.error("Gagal membuat MediaRecorder:", e);
        alert("Device/browser tidak mendukung perekaman video.");
        return;
    }

    mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
            chunks.push(e.data);
        }
    };

    mediaRecorder.onstop = () => {
        const usedType = mediaRecorder.mimeType || mimeType || "video/webm";
        const blob = new Blob(chunks, { type: usedType });

        let ext = "webm";
        if (usedType.includes("mp4")) ext = "mp4";

        const url = URL.createObjectURL(blob);
        downloadFile(url, `video.${ext}`);
    };

    mediaRecorder.start();
    isRecording = true;
}

// =============================
// STOP RECORDING
// =============================
function stopRecord() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
    }
}

// =============================
// DOWNLOAD FILE
// =============================
function downloadFile(url, filename) {
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

// =============================
// BUTTON HANDLER
// =============================

// PRESS = PHOTO
// HOLD = RECORD
captureBtn.addEventListener("touchstart", startPress);
captureBtn.addEventListener("mousedown", startPress);

captureBtn.addEventListener("touchend", endPress);
captureBtn.addEventListener("mouseup", endPress);
captureBtn.addEventListener("mouseleave", endPress);

function startPress(e) {
    e.preventDefault();
    pressTimer = setTimeout(() => {
        startRecord();
    }, 300); // tahan 0.3 detik = mulai rekam
}

function endPress(e) {
    e.preventDefault();
    clearTimeout(pressTimer);

    if (isRecording) {
        stopRecord(); // stop video
    } else {
        takePhoto(); // klik cepat = foto
    }
}
</script>

</body>
</html>
