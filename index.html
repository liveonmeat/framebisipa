<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frame Camera Portrait</title>
<style>
  body,html{margin:0;padding:0;overflow:hidden;background:#000}
  #previewCanvas{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1}
  #controls{position:fixed;bottom:25px;width:100%;display:flex;justify-content:center;gap:15px;z-index:50}
  button{font-size:18px;padding:12px 20px;border-radius:50px;border:none;background:#fff}
  #timer{position:fixed;top:20px;left:50%;transform:translateX(-50%);font-size:22px;color:#fff;z-index:50;display:none}
</style>
</head>
<body>

<canvas id="previewCanvas"></canvas>
<div id="timer">00:00</div>
<div id="controls">
  <button id="switchBtn">Switch</button>
  <button id="photoBtn">Foto</button>
  <button id="recordBtn">Rekam</button>
</div>

<script>
let canvas = document.getElementById("previewCanvas");
let ctx = canvas.getContext("2d");
let switchBtn = document.getElementById("switchBtn");
let photoBtn = document.getElementById("photoBtn");
let recordBtn = document.getElementById("recordBtn");
let timerLabel = document.getElementById("timer");

let video = document.createElement("video");
video.muted = true;
video.playsInline = true;

let frameImg = new Image();
frameImg.src = "frame.png";

let stream = null;
let facingDeviceId = null;
let otherDeviceId = null;
let isRecording = false;
let recorder, chunks = [];

let sec = 0, timerInterval = null;

// ===========================
// PILIH DEVICE CAMERA
// ===========================
async function chooseCameraIds(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoInputs = devices.filter(d=>d.kind==="videoinput");

  // cari kamera belakang/trailing jika ada label
  let back = videoInputs.find(d=>/back|rear|environment/i.test(d.label));
  let front = videoInputs.find(d=>/front|user|selfie/i.test(d.label));

  if(back) facingDeviceId = back.deviceId;
  if(front) otherDeviceId = front.deviceId;

  // jika tidak ada label, ambil urutan
  if(!facingDeviceId && videoInputs.length>0) facingDeviceId = videoInputs[0].deviceId;
  if(!otherDeviceId && videoInputs.length>1) otherDeviceId = videoInputs[1].deviceId;
}

// ===========================
// START CAMERA DENGAN DEVICEID
// ===========================
async function startCamera(deviceId){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }

  let constraints = {
    video: {
      deviceId: deviceId ? { exact: deviceId } : undefined,
      width: { ideal: 1080 },
      height: { ideal: 1920 }
    },
    audio: true
  };

  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    startRenderLoop();
  } catch(e){
    console.error("getUserMedia error", e);
  }
}

// ===========================
// RENDER CAMERA + FRAME KE CANVAS
// ===========================
function startRenderLoop(){
  canvas.width = 1080;
  canvas.height = 1920;
  function loop(){
    ctx.drawImage(video, 0,0,canvas.width,canvas.height);
    if(frameImg.complete) ctx.drawImage(frameImg, 0,0,canvas.width,canvas.height);
    requestAnimationFrame(loop);
  }
  loop();
}

// ===========================
// SWITCH CAMERA
// ===========================
switchBtn.onclick = async () => {
  await chooseCameraIds();
  const useId = (stream && stream.getVideoTracks()[0].getSettings().deviceId === facingDeviceId)
    ? otherDeviceId : facingDeviceId;
  await startCamera(useId);
};

// ===========================
// AMBIL FOTO
// ===========================
photoBtn.onclick = () => {
  let url = canvas.toDataURL("image/png");
  download(url, "photo.png");
};

// ===========================
// VIDEO RECORDING
// ===========================
recordBtn.onclick = () => {
  if(!isRecording) startRecording(); else stopRecording();
};

function startRecording(){
  isRecording = true;
  recordBtn.innerText = "Stop";
  chunks = [];

  let recordingStream = canvas.captureStream(30);
  recorder = new MediaRecorder(recordingStream, { mimeType:"video/webm" });
  recorder.ondataavailable = e=>chunks.push(e.data);
  recorder.onstop = exportVideo;
  recorder.start();

  // timer
  sec=0;
  timerLabel.style.display="block";
  timerInterval = setInterval(()=>{
    timerLabel.innerText = `00:${String(sec++).padStart(2,"0")}`;
  },1000);
}

function stopRecording(){
  isRecording = false;
  recordBtn.innerText = "Rekam";
  clearInterval(timerInterval);
  timerLabel.style.display="none";
  recorder.stop();
}

function exportVideo(){
  let blob = new Blob(chunks,{type:"video/webm"});
  let url = URL.createObjectURL(blob);
  download(url,"video.webm");
}

// ===========================
// DOWNLOAD
// ===========================
function download(url,name){
  let a=document.createElement("a");
  a.href=url;
  a.download=name;
  a.click();
}

// ===========================
// INIT on Load
// ===========================
(async ()=>{
  await chooseCameraIds();
  await startCamera(facingDeviceId);
})();
</script>

</body>
</html>
