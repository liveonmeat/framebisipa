<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camera Frame HD Portrait</title>

<style>
    body, html {
        margin:0;
        padding:0;
        overflow:hidden;
        background:#000;
        font-family: Arial, sans-serif;
    }

    #previewCanvas {
        position: fixed;
        top:0;
        left:0;
        width:100vw;
        height:100vh;
        object-fit: cover;
        background:#000;
    }

    #controls {
        position: fixed;
        bottom: 25px;
        width: 100%;
        text-align: center;
        z-index: 10;
    }

    button {
        background: white;
        padding: 12px 25px;
        border-radius: 12px;
        border: none;
        font-size: 17px;
        margin: 5px;
    }

    #timer {
        position: fixed;
        top: 25px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 22px;
        font-weight: bold;
        display:none;
        z-index: 20;
    }
</style>
</head>

<body>

<canvas id="previewCanvas"></canvas>

<div id="timer">00:00</div>

<div id="controls">
    <button id="switchBtn">Switch</button>
    <button id="photoBtn">Foto</button>
    <button id="recordBtn">Rekam</button>
</div>

<script>
let previewCanvas = document.getElementById("previewCanvas");
let ctx = previewCanvas.getContext("2d");

let switchBtn = document.getElementById("switchBtn");
let photoBtn = document.getElementById("photoBtn");
let recordBtn = document.getElementById("recordBtn");

let timer = document.getElementById("timer");

let stream;
let video = document.createElement("video");
video.setAttribute("playsinline", true);

let facing = "environment";
let isRecording = false;
let recorder;
let recordedChunks = [];
let frameImg = new Image();
frameImg.src = "snapgram.png";

let drawLoop;

// ===============================
// START CAMERA
// ===============================
async function startCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());

    stream = await navigator.mediaDevices.getUserMedia({
        video: {
            facingMode: facing,
            width: { ideal: 1080 },
            height: { ideal: 1920 }
        },
        audio: true
    });

    video.srcObject = stream;
    await video.play();

    startPreviewLoop();
}

function startPreviewLoop() {
    previewCanvas.width = 1080;
    previewCanvas.height = 1920;

    function draw() {
        ctx.drawImage(video, 0, 0, 1080, 1920);
        ctx.drawImage(frameImg, 0, 0, 1080, 1920);
        drawLoop = requestAnimationFrame(draw);
    }
    draw();
}

switchBtn.onclick = () => {
    facing = (facing === "environment") ? "user" : "environment";
    startCamera();
};

// ===============================
// FOTO FULL HD
// ===============================
photoBtn.onclick = () => {
    let canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 1920;
    let c = canvas.getContext("2d");

    c.drawImage(video, 0, 0, 1080, 1920);
    c.drawImage(frameImg, 0, 0, 1080, 1920);

    let url = canvas.toDataURL("image/png");
    download(url, "foto.png");
};

// ===============================
// TIMER
// ===============================
let timeInterval;
let sec = 0;

function startTimer() {
    sec = 0;
    timer.style.display = "block";
    timer.innerText = "00:00";

    timeInterval = setInterval(() => {
        sec++;
        let m = String(Math.floor(sec / 60)).padStart(2, "0");
        let s = String(sec % 60).padStart(2, "0");
        timer.innerText = `${m}:${s}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(timeInterval);
    timer.style.display = "none";
}

// ===============================
// VIDEO RECORD (CANVAS)
// ===============================
recordBtn.onclick = () => {
    if (!isRecording) startRecording();
    else stopRecording();
};

function startRecording() {
    isRecording = true;
    recordBtn.innerText = "Stop";

    recordedChunks = [];

    let canvasStream = previewCanvas.captureStream(30);

    recorder = new MediaRecorder(canvasStream, {
        mimeType: "video/webm; codecs=vp9",
        videoBitsPerSecond: 8000000
    });

    recorder.ondataavailable = e => recordedChunks.push(e.data);

    recorder.onstop = () => {
        let blob = new Blob(recordedChunks, { type: "video/webm" });
        download(URL.createObjectURL(blob), "video.webm");
    };

    startTimer();
    recorder.start();
}

function stopRecording() {
    isRecording = false;
    recordBtn.innerText = "Rekam";
    stopTimer();
    recorder.stop();
}

// ===============================
// DOWNLOAD FUNCTION
// ===============================
function download(url, file) {
    let a = document.createElement("a");
    a.href = url;
    a.download = file;
    a.click();
}

startCamera();
</script>

</body>
</html>
