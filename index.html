<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>WebAR – Kamera Belakang Full HD</title>

  <!-- AFRAME -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

  <!-- MINDAR FACE -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-face-aframe.prod.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }

    #overlayFrame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      pointer-events: none;
      z-index: 10;
    }

    #captureBtn {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      z-index: 20;
      border: 4px solid rgba(255,255,255,0.6);
    }
  </style>
</head>

<body>

  <!-- Frame overlay -->
  <img id="overlayFrame" src="frame.png">

  <!-- Tombol capture -->
  <div id="captureBtn"></div>

  <!-- AR SCENE -->
  <a-scene mindar-face embedded color-space="sRGB" renderer="colorManagement: true">
    <a-camera id="arCam"
      position="0 0 0"
      active="true"
      look-controls="enabled: false"
      ></a-camera>

    <!-- objek 3D jika ada -->
  </a-scene>

<script>
  // ==== FORCE REAR CAMERA FOR MINDAR ====
  document.querySelector("a-scene").addEventListener("loaded", () => {
    const system = document.querySelector("a-scene").systems["mindar-face-system"];
    system.start({ 
      video: {
        facingMode: { exact: "environment" }  // ← kamera belakang
      }
    });
  });

  // ==== RECORDING SETUP ====
  const captureBtn = document.getElementById("captureBtn");
  const scene = document.querySelector("a-scene");
  const canvas = scene.renderer.domElement;

  let recorder;
  let chunks = [];
  let holding = false;
  let holdTimer = null;

  // PHOTO capture
  function takePhoto() {
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = 1080;
    tempCanvas.height = 1920;

    const ctx = tempCanvas.getContext("2d");
    ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

    // Draw overlay frame
    const frame = document.getElementById("overlayFrame");
    ctx.drawImage(frame, 0, 0, tempCanvas.width, tempCanvas.height);

    const link = document.createElement("a");
    link.download = "photo.jpg";
    link.href = tempCanvas.toDataURL("image/jpeg", 1.0);
    link.click();
  }

  // VIDEO capture
  function startRecording() {
    const stream = canvas.captureStream(30); // 30fps
    recorder = new MediaRecorder(stream, { mimeType: "video/webm" });

    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = saveVideo;

    recorder.start();
  }

  function saveVideo() {
    const blob = new Blob(chunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.download = "video.webm";
    link.href = url;
    link.click();
  }

  // BUTTON PRESS HANDLING
  captureBtn.addEventListener("touchstart", startHold);
  captureBtn.addEventListener("mousedown", startHold);

  captureBtn.addEventListener("touchend", endHold);
  captureBtn.addEventListener("mouseup", endHold);

  function startHold() {
    holding = true;

    holdTimer = setTimeout(() => {
      if (holding) startRecording();
    }, 250); // hold for video
  }

  function endHold() {
    if (!holding) return;
    holding = false;

    clearTimeout(holdTimer);

    if (recorder && recorder.state === "recording") {
      recorder.stop();
    } else {
      takePhoto();
    }
  }
</script>
</body>
</html>
