<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebAR Camera 1080x1920</title>

<style>
    body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: Arial, sans-serif;
    }

    #preview {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
    }

    #captureBtn {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: white;
        border: 5px solid rgba(255,255,255,0.5);
        box-shadow: 0 0 10px black;
        cursor: pointer;
    }

    #overlayFrame {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        pointer-events: none;
    }
</style>

</head>
<body>

<video id="preview" autoplay playsinline muted></video>
<img id="overlayFrame" src="frame.png">
<div id="captureBtn"></div>

<canvas id="canvas" width="1080" height="1920" style="display:none;"></canvas>

<!-- FFmpeg lite (paling stabil & kecil) -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.2/dist/umd/ffmpeg-lite.min.js"></script>

<script>
// ============================
// CEK FFmpeg
// ============================
if (typeof FFmpeg === "undefined") {
    alert("FFmpeg gagal dimuat! Periksa koneksi atau refresh halaman.");
}

// Import
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: false });

// ============================
// START CAMERA
// ============================
const video = document.getElementById("preview");

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1080 },
                height: { ideal: 1920 },
                facingMode: "user"
            },
            audio: false
        });
        video.srcObject = stream;
    } catch (err) {
        alert("Kamera tidak bisa dibuka: " + err);
    }
}

startCamera();

// ============================
// FOTO (click sekali)
// VIDEO (tahan 0.5 detik)
// ============================
const btn = document.getElementById("captureBtn");
let holding = false;
let recordTimeout;
let mediaRecorder;
let chunks = [];
let stream;

// ============================
// FOTO
// ============================
function takePhoto() {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // gambar video
    ctx.drawImage(video, 0, 0, 1080, 1920);

    // gambar frame
    const frame = document.getElementById("overlayFrame");
    ctx.drawImage(frame, 0, 0, 1080, 1920);

    canvas.toBlob(function(blob) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "photo_1080x1920.png";
        a.click();
    });
}

// ============================
// MULAI REKAM (webm)
// ============================
function startRecording() {
    stream = video.srcObject;
    mediaRecorder = new MediaRecorder(stream, {
        mimeType: "video/webm;codecs=vp9"
    });

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = convertToMp4;

    chunks = [];
    mediaRecorder.start();
}

// ============================
// STOP REKAM → convert ke MP4
// ============================
async function convertToMp4() {
    const webmBlob = new Blob(chunks, { type: "video/webm" });
    const webmFile = await fetchFile(webmBlob);

    if (!ffmpeg.isLoaded()) await ffmpeg.load();

    ffmpeg.FS("writeFile", "input.webm", webmFile);

    await ffmpeg.run(
        "-i", "input.webm",
        "-vf", "scale=1080:1920",
        "-c:v", "libx264",
        "-preset", "fast",
        "-crf", "20",
        "output.mp4"
    );

    const data = ffmpeg.FS("readFile", "output.mp4");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([data.buffer], { type: "video/mp4" }));
    a.download = "video_1080x1920.mp4";
    a.click();
}

// ============================
// BUTTON BEHAVIOR
// ============================
btn.addEventListener("mousedown", () => {
    holding = true;

    recordTimeout = setTimeout(() => {
        if (holding) startRecording();
    }, 450);
});

btn.addEventListener("mouseup", () => {
    if (holding) {
        clearTimeout(recordTimeout);

        // klik cepat → foto
        if (mediaRecorder == null || mediaRecorder.state !== "recording") {
            takePhoto();
        } else {
            mediaRecorder.stop();
        }

        holding = false;
    }
});

</script>
</body>
</html>
